<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Breath Counter – Kumbhaka Prāṇāyāma</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111a2b;
      --text: #e8eefc;
      --muted: #90a4c7;
      --accent: #7cc5ff;
      --good: #30d158;
      --warn: #ffd60a;
      --bad: #ff453a;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }

    body {
      margin: 0;
      background: url('meditation%20image.jpg') center/cover no-repeat, var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      /* don't lock to screen height */
      padding: 10px 0;
      /* add some top/bottom padding */
    }

    .app {
      width: min(680px, 95vw);
      padding: 20px;
      background: rgba(17, 26, 43, 0.15);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
      backdrop-filter: blur(8px);
    }

    h1 {
      margin: 0 0 6px;
      font-size: 20px;
      letter-spacing: .5px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }

    .sub {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 16px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px
    }

    input[type="number"],
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(34, 48, 74, 0.5);
      background: rgba(14, 23, 40, 0.2);
      color: var(--text);
      font-size: 14px;
    }

    .phase {
      text-align: center;
      padding: 16px;
      border-radius: 16px;
      background: rgba(14, 23, 40, 0.2);
      border: 1px solid rgba(34, 48, 74, 0.5)
    }

    .phase h2 {
      margin: 6px 0 4px;
      font-weight: 700;
      font-size: 18px
    }

    .time {
      font-size: 42px;
      font-variant-numeric: tabular-nums;
      margin: 2px 0 10px;
    }

    .next {
      color: #ffffff;
      background: rgba(124, 197, 255, 0.3);
      font-size: 14px;
      margin-top: 8px;
      min-height: 20px;
      display: block;
      text-align: center;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid rgba(124, 197, 255, 0.5);
    }

    .controls {
      display: flex;
      gap: 10px;
      margin: 14px 0 6px;
    }

    button {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: 0;
      font-weight: 600;
      cursor: pointer;
    }

    .primary {
      background: var(--accent);
      color: #06223b
    }

    .ghost {
      background: rgba(14, 23, 40, 0.2);
      color: var(--text);
      border: 1px solid rgba(34, 48, 74, 0.5);
    }

    .danger {
      background: #1f0b10;
      color: #ffd1d1;
      border: 1px solid #512028
    }

    .stats {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .stat {
      flex: 1;
      min-width: 140px;
      background: rgba(14, 23, 40, 0.2);
      border: 1px solid rgba(34, 48, 74, 0.5);
      border-radius: 12px;
      padding: 10px
    }

    .stat .lbl {
      color: var(--muted);
      font-size: 12px
    }

    .stat .val {
      font-size: 20px;
      margin-top: 4px;
      font-variant-numeric: tabular-nums
    }

    .note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.45
    }

    .bad {
      color: var(--bad)
    }

    .warn {
      color: var(--warn)
    }

    .good {
      color: var(--good)
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .footer {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      margin-top: 10px
    }

    .big {
      font-size: 58px;
      text-transform: uppercase;
      letter-spacing: .8px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
    }

    /* Music controls */
    .music-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      padding: 8px 12px;
      background: rgba(14, 23, 40, 0.2);
      border-radius: 12px;
      border: 1px solid rgba(34, 48, 74, 0.5);
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="range"] {
      width: 80px;
      height: 4px;
      background: rgba(34, 48, 74, 0.5);
      border-radius: 2px;
      outline: none;
    }

    /* Progress tracking styles */
    .progress-section {
      margin-top: 14px;
      padding: 12px;
      background: rgba(14, 23, 40, 0.2);
      border-radius: 12px;
      border: 1px solid rgba(34, 48, 74, 0.5);
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .progress-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .progress-stat {
      text-align: center;
      padding: 8px;
      background: rgba(14, 23, 40, 0.3);
      border-radius: 8px;
      border: 1px solid rgba(34, 48, 74, 0.3);
    }

    .progress-stat .label {
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .progress-stat .value {
      font-size: 16px;
      font-weight: 600;
    }

    .streak {
      color: var(--accent);
    }

    .total-sessions {
      color: var(--good);
    }

    .toggle-progress {
      font-size: 11px;
      padding: 4px 8px;
      background: rgba(124, 197, 255, 0.2);
      border: 1px solid rgba(124, 197, 255, 0.4);
      border-radius: 6px;
      cursor: pointer;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      body {
        min-height: 100vh;
        padding: 10px;
      }

      .app {
        width: 100%;
        padding: 15px;
        max-width: none;
      }

      h1 {
        font-size: 18px;
        margin-bottom: 4px;
      }

      .sub {
        font-size: 11px;
        margin-bottom: 12px;
      }

      /* Make daily quote more compact */
      #dailyQuote {
        margin: 10px 0 !important;
        padding: 8px !important;
        font-size: 11px !important;
        line-height: 1.3 !important;
      }

      /* More compact input grid */
      .grid {
        gap: 8px;
      }

      .row {
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }

      label {
        font-size: 11px;
        margin-bottom: 4px;
      }

      input[type="number"],
      select {
        padding: 8px 10px;
        font-size: 13px;
      }

      /* More prominent phase display */
      .phase {
        padding: 12px;
        margin-top: 10px !important;
      }

      .big {
        font-size: 48px;
      }

      .time {
        font-size: 36px;
        margin: 0px 0 8px;
      }

      .next {
        font-size: 13px;
        padding: 3px 6px;
        margin-top: 6px;
      }

      /* Compact controls */
      .controls {
        margin: 10px 0 4px;
        gap: 8px;
      }

      button {
        padding: 10px 12px;
        font-size: 14px;
      }

      /* Compact stats */
      .stats {
        gap: 8px;
        margin-top: 6px;
      }

      .stat {
        min-width: 100px;
        padding: 8px;
      }

      .stat .val {
        font-size: 18px;
      }

      /* More compact progress section */
      .progress-section {
        margin-top: 10px;
        padding: 10px;
      }

      .progress-stats {
        gap: 6px;
      }

      .progress-stat {
        padding: 6px;
      }

      .progress-stat .value {
        font-size: 14px;
      }

      /* Compact note and footer */
      .note {
        font-size: 11px;
        margin-top: 8px;
        line-height: 1.4;
      }

      .footer {
        font-size: 10px;
        margin-top: 8px;
      }

      /* Stack breathing controls vertically on very small screens */
      @media (max-width: 480px) {
        .row {
          grid-template-columns: 1fr;
          gap: 8px;
        }

        .stats {
          flex-direction: column;
        }

        .stat {
          min-width: auto;
          text-align: center;
        }

        .progress-stats {
          grid-template-columns: 1fr;
        }
      }
    }
  </style>
</head>

<body>
  <main class="app" role="application" aria-label="Kumbhaka Prāṇāyāma timer">
    <!-- Audio element for temple bell only -->
    <audio id="bellAudioElement" preload="auto">
      <source src="Temple bell sound - village.mp3" type="audio/mpeg">
      <source src="Temple%20bell%20sound%20-%20village.mp3" type="audio/mpeg">
    </audio>

    <h1>Breath Counter – Kumbhaka</h1>
    <div class="sub">Adjust your cycle, tap Start, and follow the prompt. Works offline in your browser.</div>

    <!-- Daily Inspiration - Collapsible -->
    <div style="margin: 16px 0;">
      <div id="quoteToggle"
        style="cursor: pointer; font-size: 12px; color: var(--accent); margin-bottom: 8px; user-select: none;">
        ✨ Daily Inspiration (tap to toggle)
      </div>
      <div id="dailyQuote"
        style="display: none; padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; border-left: 3px solid var(--accent); font-style: italic; color: var(--muted); font-size: 13px; line-height: 1.4;">
        Loading inspiration...
      </div>
    </div>

    <div class="grid" style="margin-bottom:12px">
      <div>
        <label for="preset">Preset</label>
        <select id="preset">
          <option value="">— Custom —</option>
          <option value="4,4,4,4">Box (4-4-4-4)</option>
          <option value="4,7,8,0">4-7-8 (relax)</option>
          <option value="4,16,8,0">Kumbhaka light (4-16-8)</option>
          <option value="5,20,10,0">Kumbhaka+ (5-20-10)</option>
          <option value="6,24,12,0">Advanced (6-24-12)</option>
        </select>
      </div>
      <div class="toggle">
        <input type="checkbox" id="vibrate" checked aria-label="Vibration cues" />
        <label for="vibrate">Vibrate</label>
        <button id="testVib"
          style="margin-left: 8px; padding: 2px 6px; font-size: 10px; background: rgba(124, 197, 255, 0.2); border: 1px solid rgba(124, 197, 255, 0.4); border-radius: 4px; color: var(--text); cursor: pointer;">Test</button>
        <input type="checkbox" id="sound" checked aria-label="Sound cues" style="margin-left:14px" />
        <label for="sound">Sound</label>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Inhale (sec)</label>
        <input type="number" id="inh" min="1" max="60" step="1" value="4" />
      </div>
      <div>
        <label>Hold (sec)</label>
        <input type="number" id="hold1" min="0" max="120" step="1" value="16" />
      </div>
      <div>
        <label>Exhale (sec)</label>
        <input type="number" id="exh" min="1" max="90" step="1" value="8" />
      </div>
      <div>
        <label>Hold after exhale (sec)</label>
        <input type="number" id="hold2" min="0" max="120" step="1" value="0" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>Target cycles</label>
        <input type="number" id="target" min="1" max="999" value="10" />
      </div>
      <div>
        <label>Countdown before start (sec)</label>
        <input type="number" id="countin" min="0" max="10" value="3" />
      </div>
    </div>

    <section class="phase" aria-live="polite" aria-atomic="true" style="margin-top:14px">
      <div id="phaseName" class="big">Ready</div>
      <div id="phaseTime" class="time">00</div>
      <div class="next"><span id="nextLabel">—</span></div>
    </section>

    <div class="controls">
      <button id="start" class="primary">Start</button>
      <button id="pause" class="ghost">Pause</button>
      <button id="reset" class="danger">Reset</button>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="lbl">Cycles completed</div>
        <div id="cycles" class="val">0</div>
      </div>
      <div class="stat">
        <div class="lbl">Cycle length</div>
        <div id="cycleLen" class="val">— s</div>
      </div>
      <div class="stat">
        <div class="lbl">Elapsed</div>
        <div id="elapsed" class="val">00:00</div>
      </div>
    </div>

    <!-- Progress Tracking Section -->
    <div class="progress-section">
      <div class="progress-header">
        <h3 style="margin: 0; font-size: 14px;">Progress Tracking</h3>
        <button class="toggle-progress" id="toggleProgress">View History</button>
      </div>
      <div class="progress-stats">
        <div class="progress-stat">
          <div class="label">This Week</div>
          <div class="value" id="weekCycles">0</div>
        </div>
        <div class="progress-stat">
          <div class="label">All Time</div>
          <div class="value total-sessions" id="totalCycles">0</div>
        </div>
        <div class="progress-stat">
          <div class="label">Streak</div>
          <div class="value streak" id="currentStreak">0 days</div>
        </div>
      </div>
      <div id="progressDetails"
        style="display: none; margin-top: 10px; font-size: 11px; color: var(--muted); max-height: 120px; overflow-y: auto;">
      </div>
    </div>

    <p class="note">
      <strong>Safety:</strong> Practice breath retention gently. Avoid long holds if you have <span
        class="warn">high/low blood pressure</span>, cardiac/respiratory issues, are <span class="warn">pregnant</span>,
      or feel dizzy. Stop immediately if uncomfortable. Start with modest ratios like <span class="good">4‑4‑4‑4</span>
      or <span class="good">4‑7‑8</span> and build gradually. Consider guidance from a qualified teacher.
    </p>

    <div class="footer">Tip: Add to your phone’s Home screen to use it like an app. Your settings are saved locally.
    </div>
  </main>

  <script>
    // --- Utilities
    const $ = sel => document.querySelector(sel);
    const inputs = { inh: $('#inh'), hold1: $('#hold1'), exh: $('#exh'), hold2: $('#hold2'), target: $('#target'), countin: $('#countin') };
    const toggles = { vibrate: $('#vibrate'), sound: $('#sound') };
    const labels = { phase: $('#phaseName'), time: $('#phaseTime'), next: $('#nextLabel'), cycles: $('#cycles'), cycleLen: $('#cycleLen'), elapsed: $('#elapsed') };
    const buttons = { start: $('#start'), pause: $('#pause'), reset: $('#reset') };

    const preset = $('#preset');

    // Keep-screen-on helpers
    let wakeLock = null;        // Screen Wake Lock handle
    let keepAliveVid = null;    // Fallback hidden video (for iOS/unsupported)

    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log('🔒 Wake Lock acquired');

          // If the tab becomes visible again, re-request (some browsers release it)
          wakeLock.addEventListener('release', () => {
            console.log('🔓 Wake Lock released');
          });
          document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && running && !wakeLock) {
              try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) { }
            }
          });
        } catch (e) {
          console.log('Wake Lock error, falling back:', e);
          startFallbackVideo();
        }
      } else {
        // No Wake Lock support → fallback
        startFallbackVideo();
      }
    }

    function releaseWakeLock() {
      if (wakeLock) {
        wakeLock.release().catch(() => { }).finally(() => { wakeLock = null; });
      }
      stopFallbackVideo();
    }

    // Fallback: a tiny muted inline video keeps iOS from sleeping
    function startFallbackVideo() {
      if (keepAliveVid) return;
      keepAliveVid = document.createElement('video');
      keepAliveVid.setAttribute('playsinline', '');
      keepAliveVid.muted = true;
      keepAliveVid.loop = true;
      keepAliveVid.style.position = 'fixed';
      keepAliveVid.style.width = '1px';
      keepAliveVid.style.height = '1px';
      keepAliveVid.style.opacity = '0';
      keepAliveVid.style.pointerEvents = 'none';
      // Create a minimal data URL video as fallback
      keepAliveVid.src = 'data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMQAAAAhmdHlwaXNvbQAAAgBpc29taXNvMmF2YzEAAAAoaGRscgAAAAAAAAAAdmlkZQAAAAAAAAAAAAAAAFZpZGVvSGFuZGxlcgAAAAEoZW5jYQAAANdwcmZsAAAAAAAAAAAAAAAAgAAAAABgZ2VjdWUAAAABAAAAFAP//wNjbWVyZCAAAAcAAAAEAAAABAAAABMgZ2VjdWUAAAABAAAAFAP//wNjYWl3BQAAAgAAAAEAAAEaAAAAAA==';
      document.body.appendChild(keepAliveVid);
      keepAliveVid.play().catch(e => console.log('fallback video play error:', e));
    }

    function stopFallbackVideo() {
      if (!keepAliveVid) return;
      keepAliveVid.pause();
      keepAliveVid.src = '';
      keepAliveVid.remove();
      keepAliveVid = null;
    }

    // --- Daily Quotes by Swami Vivekananda
    const vivekanandaQuotes = [
      "Take up one idea. Make that one idea your life; dream of it; think of it; live on that idea. Let the brain, the body, muscles, nerves, every part of your body be full of that idea, and just leave every other idea alone. This is the way to success, and this is the way great spiritual giants are produced. — Swami Vivekananda",
      "You have to grow from the inside out. None can teach you, none can make you spiritual. There is no other teacher but your own soul. — Swami Vivekananda",
      "In a conflict between the heart and the brain, follow your heart. — Swami Vivekananda",
      "In a day, when you don't come across any problems - you can be sure that you are travelling in a wrong path — Swami Vivekananda",
      "The great secret of true success, of true happiness, is this: the man or woman who asks for no return, the perfectly unselfish person, is the most successful. — Swami Vivekananda",
      "All power is within you; you can do anything and everything. Believe in that, do not believe that you are weak; do not believe that you are half-crazy lunatics, as most of us do nowadays. You can do any thing and everything, without even the guidance of any one. Stand up and express the divinity within you. — Swami Vivekananda",
      "The greatest religion is to be true to your own nature. Have faith in yourselves. — Swami Vivekananda",
      "The greatest sin is to think yourself weak — Swami Vivekananda",
      "Anything that makes weak - physically, intellectually and spiritually, reject it as poison. — Swami Vivekananda",
      "Dare to be free, dare to go as far as your thought leads, and dare to carry that out in your life. — Swami Vivekananda",
      "We are what our thoughts have made us; so take care about what you think. Words are secondary. Thoughts live; they travel far. — Swami Vivekananda",
      "Arise, awake, stop not till the goal is reached. — Swami Vivekananda",
      "They alone live, who live for others. — Swami Vivekananda",
      "Be not Afraid of anything. You will do Marvelous work. it is Fearlessness that brings Heaven even in a moment. — Swami Vivekananda",
      "All love is expansion, all selfishness is contraction. Love is therefore the only law of life. He who loves lives, he who is selfish is dying. Therefore love for love's sake, because it is the only law of life, just as you breathe to live. — Swami Vivekananda",
      "You cannot believe in God until you believe in yourself. — Swami Vivekananda",
      "Neither seek nor avoid, take what comes. — Swami Vivekananda",
      "Feel nothing, know nothing, do nothing, have nothing, give up all to God, and say utterly, 'Thy will be done.' We only dream this bondage. Wake up and let it go. — Swami Vivekananda",
      "Strength is Life, Weakness is Death. Expansion is Life, Contraction is Death. Love is Life, Hatred is Death. — Swami Vivekananda",
      "Comfort is no test of truth. Truth is often far from being comfortable. — Swami Vivekananda",
      "The fire that warms us can also consume us; it is not the fault of the fire. — Swami Vivekananda",
      "Learn Everything that is Good from Others, but bring it in, and in your own way absorb it; do not become others. — Swami Vivekananda",
      "Do one thing at a Time, and while doing it put your whole Soul into it to the exclusion of all else. — Swami Vivekananda",
      "Was there ever a more horrible blasphemy than the statement that all the knowledge of God is confined to this or that book? How dare men call God infinite, and yet try to compress Him within the covers of a little book! — Swami Vivekananda",
      "Whatever you think that you will be. If you think yourself weak, weak you will be; if you think yourself strong, you will be — Swami Vivekananda",
      "All differences in this world are of degree, and not of kind, because oneness is the secret of everything. — Swami Vivekananda",
      "We are responsible for what we are, and whatever we wish ourselves to be, we have the power to make ourselves. If what we are now has been the result of our own past actions, it certainly follows that whatever we wish to be in the future can be produced by our present actions; so we have to know how to act. — Swami Vivekananda",
      "Each work has to pass through these stages—ridicule, opposition, and then acceptance. Those who think ahead of their time are sure to be misunderstood. — Swami Vivekananda",
      "Ask nothing; want nothing in return. Give what you have to give; it will come back to you, but do not think of that now. — Swami Vivekananda",
      "A fool may buy all the books in the world, and they will be in his library; but he will be able to read only those that he deserves to. — Swami Vivekananda"
    ];

    function getDailyQuote() {
      const today = new Date().toDateString();
      const savedQuote = localStorage.getItem('dailyQuote');
      const savedDate = localStorage.getItem('dailyQuoteDate');

      if (savedDate === today && savedQuote) {
        return savedQuote;
      }

      // Generate a consistent quote for today based on date
      const dateHash = today.split('').reduce((a, b) => {
        a = ((a << 5) - a) + b.charCodeAt(0);
        return a & a;
      }, 0);

      const quoteIndex = Math.abs(dateHash) % vivekanandaQuotes.length;
      const quote = vivekanandaQuotes[quoteIndex];

      localStorage.setItem('dailyQuote', quote);
      localStorage.setItem('dailyQuoteDate', today);

      return quote;
    }

    function displayDailyQuote() {
      const quote = getDailyQuote();
      $('#dailyQuote').innerHTML = `"${quote}"`;
    }

    function setupQuoteToggle() {
      const quoteToggle = $('#quoteToggle');
      const dailyQuote = $('#dailyQuote');

      // Check if quote should be visible (saved state or default to hidden on mobile)
      const isMobile = window.innerWidth <= 768;
      const quoteVisible = localStorage.getItem('quoteVisible') === 'true' || !isMobile;

      if (quoteVisible) {
        dailyQuote.style.display = 'block';
        quoteToggle.textContent = '✨ Daily Inspiration (tap to hide)';
      } else {
        dailyQuote.style.display = 'none';
        quoteToggle.textContent = '✨ Daily Inspiration (tap to show)';
      }

      quoteToggle.addEventListener('click', () => {
        const isVisible = dailyQuote.style.display !== 'none';
        if (isVisible) {
          dailyQuote.style.display = 'none';
          quoteToggle.textContent = '✨ Daily Inspiration (tap to show)';
          localStorage.setItem('quoteVisible', 'false');
        } else {
          dailyQuote.style.display = 'block';
          quoteToggle.textContent = '✨ Daily Inspiration (tap to hide)';
          localStorage.setItem('quoteVisible', 'true');
        }
      });
    }

    // --- Simple Audio System (Bell only)
    let templeBellAudio = null;

    // Initialize audio when page loads
    document.addEventListener('DOMContentLoaded', function () {
      console.log('DOM loaded, initializing temple bell audio...');
      templeBellAudio = document.getElementById('bellAudioElement');

      if (templeBellAudio) {
        templeBellAudio.volume = 0.4;
        console.log('Temple bell audio element found and volume set');

        templeBellAudio.addEventListener('loadeddata', () => {
          console.log('Temple bell loaded successfully');
        });
        templeBellAudio.addEventListener('error', (e) => {
          console.error('Temple bell failed to load:', e);
        });
      } else {
        console.error('Temple bell audio element not found!');
      }

      // Display daily quote
      displayDailyQuote();

      // Setup quote toggle functionality
      setupQuoteToggle();

      // Initialize other components
      load(); save(); makeSchedule(); updateProgressDisplay();
    });

    function playTempleBell() {
      console.log('Playing temple bell...');
      if (templeBellAudio && toggles.sound.checked) {
        templeBellAudio.currentTime = 1.5; // Skip first 1.5 seconds

        // Set up event listener to stop playback 1.5 seconds before the end
        const stopBeforeEnd = () => {
          if (templeBellAudio.currentTime >= templeBellAudio.duration - 1.5) {
            templeBellAudio.pause();
            templeBellAudio.removeEventListener('timeupdate', stopBeforeEnd);
          }
        };

        templeBellAudio.addEventListener('timeupdate', stopBeforeEnd);

        templeBellAudio.play()
          .then(() => console.log('Temple bell played'))
          .catch(e => console.log('Bell play error:', e));
      }
    }

    // Volume control (removed since no music)
    // $('#volumeSlider').addEventListener('input', (e) => {
    //   const volume = e.target.value;
    //   $('#volumeDisplay').textContent = volume + '%';
    // });

    // --- Progress Tracking System
    function getTodayKey() {
      return new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    }

    function getWeekKey() {
      const date = new Date();
      const week = Math.ceil(((date - new Date(date.getFullYear(), 0, 1)) / 86400000 + 1) / 7);
      return `${date.getFullYear()}-W${week}`;
    }

    function saveSession(cycles, duration, preset) {
      const today = getTodayKey();
      const sessionData = {
        date: today,
        time: new Date().toTimeString().split(' ')[0],
        cycles: cycles,
        duration: Math.round(duration),
        preset: preset || 'Custom',
        timestamp: Date.now()
      };

      // Get existing sessions
      let sessions = JSON.parse(localStorage.getItem('breathe_sessions') || '[]');
      sessions.push(sessionData);

      // Keep only last 90 days
      const ninetyDaysAgo = Date.now() - (90 * 24 * 60 * 60 * 1000);
      sessions = sessions.filter(s => s.timestamp > ninetyDaysAgo);

      localStorage.setItem('breathe_sessions', JSON.stringify(sessions));
      updateProgressDisplay();
    }

    function getProgressStats() {
      const sessions = JSON.parse(localStorage.getItem('breathe_sessions') || '[]');
      const today = getTodayKey();
      const thisWeek = getWeekKey();

      // This week's total cycles
      const currentWeekCycles = sessions.filter(s => {
        const sessionDate = new Date(s.date);
        const sessionWeek = getWeekKey();
        return sessionWeek === thisWeek;
      }).reduce((total, session) => total + (session.cycles || 0), 0);

      // Total cycles from all time
      const totalCycles = sessions.reduce((total, session) => total + (session.cycles || 0), 0);

      // Calculate streak
      let streak = 0;
      let checkDate = new Date();
      const sessionDates = [...new Set(sessions.map(s => s.date))].sort().reverse();

      while (streak < sessionDates.length) {
        const dateKey = checkDate.toISOString().split('T')[0];
        if (sessionDates.includes(dateKey)) {
          streak++;
          checkDate.setDate(checkDate.getDate() - 1);
        } else if (dateKey === today) {
          // If today has no sessions, check yesterday
          checkDate.setDate(checkDate.getDate() - 1);
        } else {
          break;
        }
      }

      return {
        weekCycles: currentWeekCycles,
        totalCycles,
        streak,
        sessions
      };
    }

    function updateProgressDisplay() {
      const stats = getProgressStats();

      $('#weekCycles').textContent = stats.weekCycles;
      $('#currentStreak').textContent = stats.streak + ' days';
      $('#totalCycles').textContent = stats.totalCycles;
    }

    function showProgressDetails() {
      const stats = getProgressStats();
      const details = $('#progressDetails');

      if (details.style.display === 'none') {
        let html = '<strong>Recent Sessions:</strong><br>';
        const recent = stats.sessions.slice(-10).reverse();

        if (recent.length === 0) {
          html += 'No sessions yet. Start your first session!';
        } else {
          recent.forEach(session => {
            html += `${session.date} ${session.time} - ${session.cycles} cycles (${Math.floor(session.duration / 60)}:${(session.duration % 60).toString().padStart(2, '0')})<br>`;
          });
        }

        details.innerHTML = html;
        details.style.display = 'block';
        $('#toggleProgress').textContent = 'Hide History';
      } else {
        details.style.display = 'none';
        $('#toggleProgress').textContent = 'View History';
      }
    }

    $('#toggleProgress').addEventListener('click', showProgressDetails);

    // Web Audio API for breathing phase cues
    let audioCtx = null;
    function beep(dur = 0.06, freq = 880) {
      if (!toggles.sound.checked) return;

      try {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        osc.type = 'sine';

        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);

        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + dur);
      } catch (e) {
        console.log('Audio context error:', e);
      }
    }

    function vib(p = [40]) {
      if (!toggles.vibrate.checked) {
        console.log('Vibration disabled in settings');
        return;
      }

      if (!navigator.vibrate) {
        console.log('Vibration API not supported');
        return;
      }

      try {
        const result = navigator.vibrate(p);
        console.log('Vibration triggered:', p, 'Result:', result);
        return result;
      } catch (error) {
        console.error('Vibration error:', error);
        return false;
      }
    }

    function fmt(s) { return String(s).padStart(2, '0'); }
    function mmss(sec) { sec = Math.max(0, sec | 0); const m = (sec / 60) | 0; const s = sec % 60; return `${fmt(m)}:${fmt(s)}`; }

    function save() {
      const cfg = {
        inh: +inputs.inh.value, hold1: +inputs.hold1.value, exh: +inputs.exh.value, hold2: +inputs.hold2.value,
        target: +inputs.target.value, countin: +inputs.countin.value,
        vibrate: toggles.vibrate.checked, sound: toggles.sound.checked
      };
      localStorage.setItem('kumbhaka_cfg', JSON.stringify(cfg));
    }
    function load() {
      const raw = localStorage.getItem('kumbhaka_cfg');
      if (!raw) return; try {
        const c = JSON.parse(raw);
        inputs.inh.value = c.inh; inputs.hold1.value = c.hold1; inputs.exh.value = c.exh; inputs.hold2.value = c.hold2;
        inputs.target.value = c.target; inputs.countin.value = c.countin;
        toggles.vibrate.checked = c.vibrate; toggles.sound.checked = c.sound;
      } catch (_) { }
    }

    // --- State machine
    const PHASES = ['Inhale', 'Hold', 'Exhale', 'Hold'];
    let schedule = [];
    let iPhase = 0, tRemain = 0, cycles = 0, running = false, tid = null, startedAt = null, elapsedBase = 0;
    let countdownId = null;
    let preId = null;        // countdown timeout handle
    let preRemain = 0;       // countdown seconds remaining

    function makeSchedule() {
      const i = +inputs.inh.value, h1 = +inputs.hold1.value, e = +inputs.exh.value, h2 = +inputs.hold2.value;
      schedule = [['Inhale', i], ['Hold', h1], ['Exhale', e], ['Hold', h2]].filter(([_, d]) => d > 0);
      const cyc = i + h1 + e + h2; labels.cycleLen.textContent = `${cyc} s`;
    }

    function nextPhase() {
      if (schedule.length === 0) { makeSchedule(); }
      iPhase = (iPhase + 1) % schedule.length;
      const [name, dur] = schedule[iPhase];
      tRemain = dur;
      labels.phase.textContent = name;
      const next = schedule[(iPhase + 1) % schedule.length]?.[0] || '—';
      labels.next.textContent = `Next: ${next}`;

      // Different beep sounds for different phases - longer and more distinct
      if (name === 'Inhale') {
        beep(0.25, 440); // Longer, lower tone for inhale phase change
      } else if (name === 'Hold') {
        beep(0.25, 660); // Longer, medium tone for hold phase change
      } else if (name === 'Exhale') {
        beep(0.25, 330); // Longer, lowest tone for exhale phase change
      }

      vib([60]);
      if (iPhase === 0) { // new cycle starting
        cycles += 1; labels.cycles.textContent = cycles;

        // Stop when we've completed the target cycles
        if (cycles > +inputs.target.value) {
          stop(); return;
        }

        // Show target reached message when we reach the target
        if (cycles >= +inputs.target.value) {
          labels.cycles.textContent = cycles + ' ✓';
        }
      }
    }

    function tick() {
      if (!running) return;
      if (tRemain <= 0) { nextPhase(); }
      labels.time.textContent = fmt(tRemain);

      // Add countdown beeps for each second (but not on the last second before phase change)
      if (tRemain > 1) {
        beep(0.05, 800); // Short, subtle countdown beep
      }

      tRemain -= 1;
      const elapsed = elapsedBase + ((Date.now() - startedAt) | 0);
      labels.elapsed.textContent = mmss(elapsed / 1000);
      tid = setTimeout(tick, 1000);
    }

    function start() {
      save(); makeSchedule();
      if (running) return;                 // prevent double-start
      running = true;
      startedAt = Date.now();

      // Keep screen on during session
      requestWakeLock();

      // reset counters when starting from Ready/Done
      if (labels.phase.textContent === 'Ready' || labels.phase.textContent === 'Done') {
        iPhase = 0; cycles = 0; elapsedBase = 0;
        labels.cycles.textContent = '0';
      }

      const ci = (+inputs.countin.value) | 0;

      // clear any previous timers
      if (preId) { clearTimeout(preId); preId = null; }
      if (countdownId) { clearTimeout(countdownId); countdownId = null; } // (if you had one before)
      clearTimeout(tid);

      if (ci > 0) {
        // Show Get Ready countdown using *separate* variables
        labels.phase.textContent = 'Get Ready';
        labels.next.textContent = 'Next: Inhale';
        preRemain = ci;
        labels.time.textContent = fmt(preRemain);

        // optional first cue
        beep(0.05, 660); vib([30]);

        const step = () => {
          if (!running) return;                 // paused/stopped → abort
          if (preRemain <= 0) {
            preId = null;
            // Position so nextPhase() starts at first phase
            iPhase = schedule.length - 1;
            nextPhase();
            tick();                              // start main loop
            return;
          }

          labels.time.textContent = fmt(preRemain);
          beep(0.05, 660); vib([25]);
          preRemain -= 1;
          preId = setTimeout(step, 1000);
        };

        preId = setTimeout(step, 1000);          // start countdown after 1s
        return;                                   // do NOT start tick() yet
      }

      // No countdown → start immediately
      iPhase = schedule.length - 1;
      nextPhase();
      tick();
    } function pause() {
      if (!running) return;
      running = false;
      releaseWakeLock();
      clearTimeout(tid);
      if (preId) { clearTimeout(preId); preId = null; }
      if (countdownId) { clearTimeout(countdownId); countdownId = null; }
      elapsedBase += (Date.now() - startedAt);
      labels.phase.textContent += ' (paused)';
    }

    function stop() {
      running = false;
      releaseWakeLock();
      clearTimeout(tid);
      if (preId) { clearTimeout(preId); preId = null; }
      if (countdownId) { clearTimeout(countdownId); countdownId = null; }
      iPhase = 0;
      tRemain = 0;
      labels.phase.textContent = 'Done';
      labels.time.textContent = '00';

      // Play temple bell at completion (only when target cycles reached)
      if (cycles > 0 && cycles >= +inputs.target.value) {
        playTempleBell();
      }

      // Save the completed session
      if (cycles > 0) {
        const duration = (elapsedBase + (Date.now() - startedAt)) / 1000;
        const currentPreset = preset.value ? preset.options[preset.selectedIndex].text : 'Custom';
        saveSession(cycles, duration, currentPreset);
      }
    }

    function reset() {
      running = false;
      releaseWakeLock();
      clearTimeout(tid);
      if (preId) { clearTimeout(preId); preId = null; }
      if (countdownId) { clearTimeout(countdownId); countdownId = null; }
      iPhase = 0; tRemain = 0; cycles = 0; elapsedBase = 0;
      labels.phase.textContent = 'Ready';
      labels.time.textContent = '00';
      labels.next.textContent = '—';
      labels.elapsed.textContent = '00:00';
      labels.cycles.textContent = '0';
    }

    // Events
    buttons.start.addEventListener('click', start);
    buttons.pause.addEventListener('click', pause);
    buttons.reset.addEventListener('click', reset);

    // Test vibration button
    $('#testVib').addEventListener('click', () => {
      console.log('Testing vibration...');
      if (!navigator.vibrate) {
        alert('Vibration not supported on this device/browser');
        return;
      }
      if (!toggles.vibrate.checked) {
        alert('Please enable vibration first');
        return;
      }
      const result = vib([100, 50, 100]);
      console.log('Vibration test result:', result);
      if (!result) {
        alert('Vibration failed - check browser settings or try HTTPS');
      }
    });

    preset.addEventListener('change', e => {
      if (!e.target.value) return; const [a, b, c, d] = e.target.value.split(',').map(x => +x);
      inputs.inh.value = a; inputs.hold1.value = b; inputs.exh.value = c; inputs.hold2.value = d; save(); makeSchedule();
    });

    Object.values(inputs).forEach(inp => inp.addEventListener('change', () => { save(); makeSchedule(); }));
    Object.values(toggles).forEach(inp => inp.addEventListener('change', save));

    // Enable audio and test vibration on first user click (required by browsers)
    document.addEventListener('click', async function () {
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        console.log('✅ User clicked - audio enabled');

        // Test vibration if enabled
        if (toggles.vibrate.checked && navigator.vibrate) {
          const vibResult = navigator.vibrate(50);
          console.log('✅ Vibration test:', vibResult ? 'SUCCESS' : 'FAILED');
        }
      } catch (e) {
        console.log('Audio/vibration setup error:', e);
      }
    }, { once: true });
  </script>
</body>

</html>